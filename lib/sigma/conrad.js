!function(e){"use strict";function r(e,t){var n,i,o;if(arguments.length)if(1===arguments.length&&Object(arguments[0])===arguments[0])for(e in arguments[0])r(e,arguments[0][e]);else if(arguments.length>1){o=Array.isArray(e)?e:e.split(/ /);for(n in o)i=o[n],D[i]||(D[i]=[]),D[i].push({handler:t})}}function t(e,r){var t,n,i,o,a=Array.isArray(e)?e:e.split(/ /);if(arguments.length)if(r)for(t in a){if(o=a[t],D[o]){i=[];for(n in D[o])D[o][n].handler!==r&&i.push(D[o][n]);D[o]=i}D[o]&&0===D[o].length&&delete D[o]}else for(t in a)delete D[a[t]];else D=Object.create(null)}function n(e,r){var t,n,i,o,a=Array.isArray(e)?e:e.split(/ /);r=void 0===r?{}:r;for(t in a)if(o=a[t],D[o]){i={type:o,data:r||{}};for(n in D[o])try{D[o][n].handler(i)}catch(f){}}}function i(){var e,r,t,n,i=!1,o=b(),a=j.shift();if(t=a.job(),o=b()-o,a.done++,a.time+=o,a.currentTime+=o,a.weightTime=a.currentTime/(a.weight||1),a.averageTime=a.time/a.done,n=a.count?a.count<=a.done:!t,!n){for(e=0,r=j.length;r>e;e++)if(j[e].weightTime>a.weightTime){j.splice(e,0,a),i=!0;break}i||j.push(a)}return n?a:null}function o(e){var r=j.length;T[e.id]=e,e.status="running",r&&(e.weightTime=j[r-1].weightTime,e.currentTime=e.weightTime*(e.weight||1)),e.startTime=b(),n("jobStarted",m(e)),j.push(e)}function a(){var e,r,t;for(e in A)r=A[e],r.after?J[e]=r:o(r),delete A[e];for(v=!!j.length;j.length&&b()-w<E.frameDuration;)if(t=i()){s(t.id);for(e in J)J[e].after===t.id&&(o(J[e]),delete J[e])}v?(w=b(),n("enterFrame"),setTimeout(a,0)):n("stop")}function f(e,r){var t,i,o;if(Array.isArray(e)){for(x=!0,t=0,i=e.length;i>t;t++)f(e[t].id,p(e[t],r));x=!1,v||(w=b(),n("start"),a())}else if("object"==typeof e)if("string"==typeof e.id)f(e.id,e);else{x=!0;for(t in e)"function"==typeof e[t]?f(t,p({job:e[t]},r)):f(t,p(e[t],r));x=!1,v||(w=b(),n("start"),a())}else{if("string"!=typeof e)throw new Error("[conrad.addJob] Wrong arguments.");if(c(e))throw new Error('[conrad.addJob] Job with id "'+e+'" already exists.');if("function"==typeof r)o={id:e,done:0,time:0,status:"waiting",currentTime:0,averageTime:0,weightTime:0,job:r};else{if("object"!=typeof r)throw new Error("[conrad.addJob] Wrong arguments.");o=p({id:e,done:0,time:0,status:"waiting",currentTime:0,averageTime:0,weightTime:0},r)}A[e]=o,n("jobAdded",m(o)),v||x||(w=b(),n("start"),a())}return this}function s(e){var r,t,i,o,a=!1;if(Array.isArray(e))for(r=0,t=e.length;t>r;r++)s(e[r]);else{if("string"!=typeof e)throw new Error("[conrad.killJob] Wrong arguments.");for(i=[T,J,A],r=0,t=i.length;t>r;r++)e in i[r]&&(o=i[r][e],E.history&&(o.status="done",k.push(o)),n("jobEnded",m(o)),delete i[r][e],"function"==typeof o.end&&o.end(),a=!0);for(i=j,r=0,t=i.length;t>r;r++)if(i[r].id===e){i.splice(r,1);break}if(!a)throw new Error('[conrad.killJob] Job "'+e+'" not found.')}return this}function u(){var e,r=p(A,T,J);if(E.history)for(e in r)r[e].status="done",k.push(r[e]),"function"==typeof r[e].end&&r[e].end();return A={},J={},T={},j=[],v=!1,this}function c(e){var r=A[e]||T[e]||J[e];return r?p(r):null}function d(){var e;if("string"==typeof a1&&1===arguments.length)return E[a1];e="object"==typeof a1&&1===arguments.length?a1||{}:{},"string"==typeof a1&&(e[a1]=a2);for(var r in e)void 0!==e[r]?E[r]=e[r]:delete E[r];return this}function g(){return v}function l(){return k=[],this}function h(e,r){var t,n,i,o,a,f,s;if(!arguments.length){a=[];for(n in A)a.push(A[n]);for(n in J)a.push(J[n]);for(n in T)a.push(T[n]);a=a.concat(k)}if("string"==typeof e)switch(e){case"waiting":a=y(J);break;case"running":a=y(T);break;case"done":a=k;break;default:f=e}if(e instanceof RegExp&&(f=e),!f&&("string"==typeof r||r instanceof RegExp)&&(f=r),f){if(s="string"==typeof f,a instanceof Array)t=a;else if("object"==typeof a){t=[];for(n in a)t=t.concat(a[n])}else{t=[];for(n in A)t.push(A[n]);for(n in J)t.push(J[n]);for(n in T)t.push(T[n]);t=t.concat(k)}for(a=[],i=0,o=t.length;o>i;i++)(s?t[i].id===f:t[i].id.match(f))&&a.push(t[i])}return m(a)}function p(){var e,r,t={},n=arguments.length;for(e=n-1;e>=0;e--)for(r in arguments[e])t[r]=arguments[e][r];return t}function m(e){var r,t,n;if(!e)return e;if(Array.isArray(e))for(r=[],t=0,n=e.length;n>t;t++)r.push(m(e[t]));else if("object"==typeof e){r={};for(t in e)r[t]=m(e[t])}else r=e;return r}function y(e){var r,t=[];for(r in e)t.push(e[r]);return t}function b(){return Date.now?Date.now():(new Date).getTime()}if(e.conrad)throw new Error("conrad already exists");var w,v=!1,A={},T={},j=[],J={},k=[],x=!1,E={frameDuration:20,history:!0},D=Object.create(null);Array.isArray||(Array.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)});var O={hasJob:c,addJob:f,killJob:s,killAll:u,settings:d,getStats:h,isRunning:g,clearHistory:l,bind:r,unbind:t,version:"0.1.0"};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=O),exports.conrad=O):e.conrad=O}(this);