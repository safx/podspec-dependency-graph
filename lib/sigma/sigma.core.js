(function(){"use strict";var e={},r=function(t){var s,i,n,a,d;r.classes.dispatcher.extend(this);var h=this,o=t||{};if("string"==typeof o||o instanceof HTMLElement?o={renderers:[o]}:"[object Array]"===Object.prototype.toString.call(o)&&(o={renderers:o}),a=o.renderers||o.renderer||o.container,o.renderers&&0!==o.renderers.length||("string"==typeof a||a instanceof HTMLElement||"object"==typeof a&&"container"in a)&&(o.renderers=[a]),o.id){if(e[o.id])throw'sigma: Instance "'+o.id+'" already exists.';Object.defineProperty(this,"id",{value:o.id})}else{for(d=0;e[d];)d++;Object.defineProperty(this,"id",{value:""+d})}for(e[this.id]=this,this.settings=new r.classes.configurable(r.settings,o.settings||{}),Object.defineProperty(this,"graph",{value:new r.classes.graph(this.settings),configurable:!0}),Object.defineProperty(this,"middlewares",{value:[],configurable:!0}),Object.defineProperty(this,"cameras",{value:{},configurable:!0}),Object.defineProperty(this,"renderers",{value:{},configurable:!0}),Object.defineProperty(this,"renderersPerCamera",{value:{},configurable:!0}),Object.defineProperty(this,"cameraFrames",{value:{},configurable:!0}),this._handler=function(e){var r,t={};for(r in e.data)t[r]=e.data[r];t.renderer=e.target,this.dispatchEvent(e.type,t)}.bind(this),n=o.renderers||[],s=0,i=n.length;i>s;s++)this.addRenderer(n[s]);for(n=o.middlewares||[],s=0,i=n.length;i>s;s++)this.middlewares.push("string"==typeof n[s]?r.middlewares[n[s]]:n[s]);"object"==typeof o.graph&&o.graph&&(this.graph.read(o.graph),this.refresh()),window.addEventListener("resize",function(){h.settings&&h.refresh()})};if(r.prototype.addCamera=function(e){var t,s=this;if(!arguments.length){for(e=0;this.cameras[""+e];)e++;e=""+e}if(this.cameras[e])throw'sigma.addCamera: The camera "'+e+'" already exists.';return t=new r.classes.camera(e,this.graph,this.settings),this.cameras[e]=t,t.quadtree=new r.classes.quad,t.bind("coordinatesUpdated",function(){s.renderCamera(t,t.isAnimated)}),this.renderersPerCamera[e]=[],t},r.prototype.killCamera=function(e){if(e="string"==typeof e?this.cameras[e]:e,!e)throw"sigma.killCamera: The camera is undefined.";var r,t,s=this.renderersPerCamera[e.id];for(t=s.length,r=t-1;r>=0;r--)this.killRenderer(s[r]);return delete this.renderersPerCamera[e.id],delete this.cameraFrames[e.id],delete this.cameras[e.id],e.kill&&e.kill(),this},r.prototype.addRenderer=function(e){var t,s,i,n,a=e||{};if("string"==typeof a?a={container:document.getElementById(a)}:a instanceof HTMLElement&&(a={container:a}),"id"in a)t=a.id;else{for(t=0;this.renderers[""+t];)t++;t=""+t}if(this.renderers[t])throw'sigma.addRenderer: The renderer "'+t+'" already exists.';if(s="function"==typeof a.type?a.type:r.renderers[a.type],s=s||r.renderers.def,i="camera"in a?a.camera instanceof r.classes.camera?a.camera:this.cameras[a.camera]||this.addCamera(a.camera):this.addCamera(),this.cameras[i.id]!==i)throw"sigma.addRenderer: The camera is not properly referenced.";return n=new s(this.graph,i,this.settings,a),this.renderers[t]=n,Object.defineProperty(n,"id",{value:t}),n.bind&&n.bind(["click","clickStage","clickNode","clickNodes","overNode","overNodes","outNode","outNodes","downNode","downNodes","upNode","upNodes"],this._handler),this.renderersPerCamera[i.id].push(n),n},r.prototype.killRenderer=function(e){if(e="string"==typeof e?this.renderers[e]:e,!e)throw"sigma.killRenderer: The renderer is undefined.";var r=this.renderersPerCamera[e.camera.id],t=r.indexOf(e);return t>=0&&r.splice(t,1),e.kill&&e.kill(),delete this.renderers[e.id],this},r.prototype.refresh=function(){var e,t,s,i,n,a,d=0;for(i=this.middlewares||[],e=0,t=i.length;t>e;e++)i[e].call(this,0===e?"":"tmp"+d+":",e===t-1?"ready:":"tmp"+ ++d+":");for(s in this.cameras)n=this.cameras[s],n.settings("autoRescale")&&this.renderersPerCamera[n.id]&&this.renderersPerCamera[n.id].length?r.middlewares.rescale.call(this,i.length?"ready:":"",n.readPrefix,{width:this.renderersPerCamera[n.id][0].width,height:this.renderersPerCamera[n.id][0].height}):r.middlewares.copy.call(this,i.length?"ready:":"",n.readPrefix),a=r.utils.getBoundaries(this.graph,n.readPrefix),n.quadtree.index(this.graph.nodes(),{prefix:n.readPrefix,bounds:{x:a.minX,y:a.minY,width:a.maxX-a.minX,height:a.maxY-a.minY}});for(i=Object.keys(this.renderers),e=0,t=i.length;t>e;e++)if(this.renderers[i[e]].process)if(this.settings("skipErrors"))try{this.renderers[i[e]].process()}catch(h){console.log('Warning: The renderer "'+i[e]+'" crashed on ".process()"')}else this.renderers[i[e]].process();return this.render(),this},r.prototype.render=function(){var e,r,t;for(t=Object.keys(this.renderers),e=0,r=t.length;r>e;e++)if(this.settings("skipErrors"))try{this.renderers[t[e]].render()}catch(s){this.settings("verbose")&&console.log('Warning: The renderer "'+t[e]+'" crashed on ".render()"')}else this.renderers[t[e]].render();return this},r.prototype.renderCamera=function(e,r){var t,s,i,n=this;if(r)for(i=this.renderersPerCamera[e.id],t=0,s=i.length;s>t;t++)if(this.settings("skipErrors"))try{i[t].render()}catch(a){this.settings("verbose")&&console.log('Warning: The renderer "'+i[t].id+'" crashed on ".render()"')}else i[t].render();else if(!this.cameraFrames[e.id]){for(i=this.renderersPerCamera[e.id],t=0,s=i.length;s>t;t++)if(this.settings("skipErrors"))try{i[t].render()}catch(a){this.settings("verbose")&&console.log('Warning: The renderer "'+i[t].id+'" crashed on ".render()"')}else i[t].render();this.cameraFrames[e.id]=requestAnimationFrame(function(){delete n.cameraFrames[e.id]})}return this},r.prototype.kill=function(){var r;this.graph.kill(),delete this.middlewares;for(r in this.renderers)this.killRenderer(this.renderers[r]);for(r in this.cameras)this.killCamera(this.cameras[r]);delete this.renderers,delete this.cameras;for(r in this)this.hasOwnProperty(r)&&delete this[r];delete e[this.id]},r.instances=function(t){return arguments.length?e[t]:r.utils.extend({},e)},"undefined"!=typeof this.sigma)throw"An object called sigma is already in the global scope.";"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=r),exports.sigma=r):this.sigma=r}).call(this);