(function(t){"use strict";if("undefined"==typeof sigma)throw"sigma is not declared";sigma.utils.pkg("sigma.renderers"),sigma.renderers.webgl=function(t,e,s,i){if("object"!=typeof i)throw"sigma.renderers.webgl: Wrong arguments.";if(!(i.container instanceof HTMLElement))throw"Container not found.";var r,a,h,n,o=this;for(sigma.classes.dispatcher.extend(this),this.jobs={},Object.defineProperty(this,"conradId",{value:sigma.utils.id()}),this.graph=t,this.camera=e,this.contexts={},this.domElements={},this.options=i,this.container=this.options.container,this.settings="object"==typeof i.settings&&i.settings?s.embedObjects(i.settings):s,this.options.prefix=this.camera.readPrefix,Object.defineProperty(this,"nodePrograms",{value:{}}),Object.defineProperty(this,"edgePrograms",{value:{}}),Object.defineProperty(this,"nodeFloatArrays",{value:{}}),Object.defineProperty(this,"edgeFloatArrays",{value:{}}),this.initDOM("canvas","scene",!0),this.initDOM("canvas","labels"),this.initDOM("canvas","mouse"),this.contexts.hover=this.contexts.mouse,this.contexts.nodes=this.contexts.scene,this.contexts.edges=this.contexts.scene,this.captors=[],h=this.options.captors||[sigma.captors.mouse,sigma.captors.touch],r=0,a=h.length;a>r;r++)n="function"==typeof h[r]?h[r]:sigma.captors[h[r]],this.captors.push(new n(this.domElements.mouse,this.camera,this.settings));window.addEventListener("resize",function(){o.resize()}),sigma.misc.bindEvents.call(this,this.camera.prefix),sigma.misc.drawHovers.call(this,this.camera.prefix),this.resize()},sigma.renderers.webgl.prototype.process=function(){var t,e,s,i,r,a=this.graph,h=sigma.utils.extend(h,this.options);for(i in this.nodeFloatArrays)delete this.nodeFloatArrays[i];for(i in this.edgeFloatArrays)delete this.edgeFloatArrays[i];for(t=a.edges(),e=0,s=t.length;s>e;e++)i=t[e].type&&sigma.webgl.edges[t[e].type]?t[e].type:"def",this.edgeFloatArrays[i]||(this.edgeFloatArrays[i]={edges:[]}),this.edgeFloatArrays[i].edges.push(t[e]);for(t=a.nodes(),e=0,s=t.length;s>e;e++)i=t[e].type&&sigma.webgl.nodes[t[e].type]?i:"def",this.nodeFloatArrays[i]||(this.nodeFloatArrays[i]={nodes:[]}),this.nodeFloatArrays[i].nodes.push(t[e]);for(i in this.edgeFloatArrays)for(r=sigma.webgl.edges[i],t=this.edgeFloatArrays[i].edges,e=0,s=t.length;s>e;e++)this.edgeFloatArrays[i].array||(this.edgeFloatArrays[i].array=new Float32Array(t.length*r.POINTS*r.ATTRIBUTES)),t[e].hidden||a.nodes(t[e].source).hidden||a.nodes(t[e].target).hidden||r.addEdge(t[e],a.nodes(t[e].source),a.nodes(t[e].target),this.edgeFloatArrays[i].array,e*r.POINTS*r.ATTRIBUTES,h.prefix,this.settings);for(i in this.nodeFloatArrays)for(r=sigma.webgl.nodes[i],t=this.nodeFloatArrays[i].nodes,e=0,s=t.length;s>e;e++)this.nodeFloatArrays[i].array||(this.nodeFloatArrays[i].array=new Float32Array(t.length*r.POINTS*r.ATTRIBUTES)),t[e].hidden||r.addNode(t[e],this.nodeFloatArrays[i].array,e*r.POINTS*r.ATTRIBUTES,h.prefix,this.settings);return this},sigma.renderers.webgl.prototype.render=function(e){var s,i,r,a,h,n,o=this,g=(this.graph,this.contexts.nodes),d=this.contexts.edges,l=this.camera.getMatrix(),m=sigma.utils.extend(e,this.options),c=this.settings(m,"drawLabels"),p=this.settings(m,"drawEdges"),y=this.settings(m,"drawNodes");this.settings(m,"hideEdgesOnMove")&&(this.camera.isAnimated||this.camera.isMoving)&&(p=!1),this.clear(),l=sigma.utils.matrices.multiply(l,sigma.utils.matrices.translation(this.width/2,this.height/2));for(a in this.jobs)conrad.hasJob(a)&&conrad.killJob(a);if(p)if(this.settings(m,"batchEdgesDrawing"))(function(){var t,e,s,i,r,a,h,n,o;s="edges_"+this.conradId,o=this.settings(m,"webglEdgesBatchSize"),t=Object.keys(this.edgeFloatArrays),t.length&&(e=0,n=sigma.webgl.edges[t[e]],r=this.edgeFloatArrays[t[e]].array,h=0,a=Math.min(h+o*n.POINTS,r.length/n.ATTRIBUTES),i=function(){return this.edgePrograms[t[e]]||(this.edgePrograms[t[e]]=n.initProgram(d)),a>h&&(d.useProgram(this.edgePrograms[t[e]]),n.render(d,this.edgePrograms[t[e]],r,{settings:this.settings,matrix:l,width:this.width,height:this.height,ratio:this.camera.ratio,scalingRatio:this.settings("webglOversamplingRatio"),start:h,count:a-h})),a>=r.length/n.ATTRIBUTES&&e===t.length-1?(delete this.jobs[s],!1):(a>=r.length/n.ATTRIBUTES?(e++,r=this.edgeFloatArrays[t[e]].array,n=sigma.webgl.edges[t[e]],h=0,a=Math.min(h+o*n.POINTS,r.length/n.ATTRIBUTES)):(h=a,a=Math.min(h+o*n.POINTS,r.length/n.ATTRIBUTES)),!0)},this.jobs[s]=i,conrad.addJob(s,i.bind(this)))}).call(this);else for(a in this.edgeFloatArrays)n=sigma.webgl.edges[a],this.edgePrograms[a]||(this.edgePrograms[a]=n.initProgram(d)),this.edgeFloatArrays[a]&&(d.useProgram(this.edgePrograms[a]),n.render(d,this.edgePrograms[a],this.edgeFloatArrays[a].array,{settings:this.settings,matrix:l,width:this.width,height:this.height,ratio:this.camera.ratio,scalingRatio:this.settings("webglOversamplingRatio")}));if(y){g.blendFunc(g.SRC_ALPHA,g.ONE_MINUS_SRC_ALPHA),g.enable(g.BLEND);for(a in this.nodeFloatArrays)n=sigma.webgl.nodes[a],this.nodePrograms[a]||(this.nodePrograms[a]=n.initProgram(g)),this.nodeFloatArrays[a]&&(g.useProgram(this.nodePrograms[a]),n.render(g,this.nodePrograms[a],this.nodeFloatArrays[a].array,{settings:this.settings,matrix:l,width:this.width,height:this.height,ratio:this.camera.ratio,scalingRatio:this.settings("webglOversamplingRatio")}))}if(c)for(s=this.camera.quadtree.area(this.camera.getRectangle(this.width,this.height)),this.camera.applyView(t,t,{nodes:s,edges:[],width:this.width,height:this.height}),h=function(t){return o.settings({prefix:o.camera.prefix},t)},i=0,r=s.length;r>i;i++)s[i].hidden||(sigma.canvas.labels[s[i].type]||sigma.canvas.labels.def)(s[i],this.contexts.labels,h);return this.dispatchEvent("render"),this},sigma.renderers.webgl.prototype.initDOM=function(t,e,s){var i=document.createElement(t);i.style.position="absolute",i.setAttribute("class","sigma-"+e),this.domElements[e]=i,this.container.appendChild(i),"canvas"===t.toLowerCase()&&(this.contexts[e]=i.getContext(s?"experimental-webgl":"2d",{preserveDrawingBuffer:!0}))},sigma.renderers.webgl.prototype.resize=function(e,s){var i,r=this.width,a=this.height;if(e!==t&&s!==t?(this.width=e,this.height=s):(this.width=this.container.offsetWidth,this.height=this.container.offsetHeight,e=this.width,s=this.height),r!==this.width||a!==this.height)for(i in this.domElements)this.domElements[i].style.width=e+"px",this.domElements[i].style.height=s+"px","canvas"===this.domElements[i].tagName.toLowerCase()&&(this.contexts[i]&&this.contexts[i].scale?(this.domElements[i].setAttribute("width",e+"px"),this.domElements[i].setAttribute("height",s+"px")):(this.domElements[i].setAttribute("width",e*this.settings("webglOversamplingRatio")+"px"),this.domElements[i].setAttribute("height",s*this.settings("webglOversamplingRatio")+"px")));for(i in this.contexts)this.contexts[i]&&this.contexts[i].viewport&&this.contexts[i].viewport(0,0,this.width*this.settings("webglOversamplingRatio"),this.height*this.settings("webglOversamplingRatio"));return this},sigma.renderers.webgl.prototype.clear=function(){var t;for(t in this.domElements)"CANVAS"===this.domElements[t].tagName&&(this.domElements[t].width=this.domElements[t].width);return this.contexts.nodes.clear(this.contexts.nodes.COLOR_BUFFER_BIT),this.contexts.edges.clear(this.contexts.edges.COLOR_BUFFER_BIT),this},sigma.utils.pkg("sigma.webgl.nodes"),sigma.utils.pkg("sigma.webgl.edges"),sigma.utils.pkg("sigma.canvas.labels")}).call(this);