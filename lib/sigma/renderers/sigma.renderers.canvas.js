(function(t){"use strict";if("undefined"==typeof sigma)throw"sigma is not declared";if("undefined"==typeof conrad)throw"conrad is not declared";sigma.utils.pkg("sigma.renderers"),sigma.renderers.canvas=function(t,s,e,i){if("object"!=typeof i)throw"sigma.renderers.canvas: Wrong arguments.";if(!(i.container instanceof HTMLElement))throw"Container not found.";var n,h,a,o,r=this;for(sigma.classes.dispatcher.extend(this),Object.defineProperty(this,"conradId",{value:sigma.utils.id()}),this.graph=t,this.camera=s,this.contexts={},this.domElements={},this.options=i,this.container=this.options.container,this.settings="object"==typeof i.settings&&i.settings?e.embedObjects(i.settings):e,this.nodesOnScreen=[],this.edgesOnScreen=[],this.jobs={},this.options.prefix="renderer"+this.conradId+":",this.settings("batchEdgesDrawing")?(this.initDOM("canvas","edges"),this.initDOM("canvas","scene"),this.contexts.nodes=this.contexts.scene,this.contexts.labels=this.contexts.scene):(this.initDOM("canvas","scene"),this.contexts.edges=this.contexts.scene,this.contexts.nodes=this.contexts.scene,this.contexts.labels=this.contexts.scene),this.initDOM("canvas","mouse"),this.contexts.hover=this.contexts.mouse,this.captors=[],a=this.options.captors||[sigma.captors.mouse,sigma.captors.touch],n=0,h=a.length;h>n;n++)o="function"==typeof a[n]?a[n]:sigma.captors[a[n]],this.captors.push(new o(this.domElements.mouse,this.camera,this.settings));window.addEventListener("resize",function(){r.resize()}),sigma.misc.bindEvents.call(this,this.options.prefix),sigma.misc.drawHovers.call(this,this.options.prefix),this.resize(!1)},sigma.renderers.canvas.prototype.render=function(s){s=s||{};var e,i,n,h,a,o,r,d,c,g,m,l,p={},f=this.graph,u=this.graph.nodes,v=(this.options.prefix||"",this.settings(s,"drawEdges")),x=this.settings(s,"drawNodes"),b=this.settings(s,"drawLabels"),w=this.settings.embedObjects(s,{prefix:this.options.prefix});this.settings(s,"hideEdgesOnMove")&&(this.camera.isAnimated||this.camera.isMoving)&&(v=!1),this.camera.applyView(t,this.options.prefix,{width:this.width,height:this.height}),this.clear();for(n in this.jobs)conrad.hasJob(n)&&conrad.killJob(n);for(this.edgesOnScreen=[],this.nodesOnScreen=this.camera.quadtree.area(this.camera.getRectangle(this.width,this.height)),e=this.nodesOnScreen,i=0,h=e.length;h>i;i++)p[e[i].id]=e[i];if(v){for(e=f.edges(),i=0,h=e.length;h>i;i++)a=e[i],!p[a.source]&&!p[a.target]||a.hidden||u(a.source).hidden||u(a.target).hidden||this.edgesOnScreen.push(a);if(this.settings(s,"batchEdgesDrawing"))o="edges_"+this.conradId,l=w("canvasEdgesBatchSize"),g=this.edgesOnScreen,h=g.length,c=0,r=Math.min(g.length,c+l),d=function(){for(m=sigma.canvas.edges,i=c;r>i;i++)a=g[i],(m[a.type]||m.def)(a,f.nodes(a.source),f.nodes(a.target),this.contexts.edges,w);return r===g.length?(delete this.jobs[o],!1):(c=r+1,r=Math.min(g.length,c+l),!0)},this.jobs[o]=d,conrad.addJob(o,d.bind(this));else for(m=sigma.canvas.edges,e=this.edgesOnScreen,i=0,h=e.length;h>i;i++)a=e[i],(m[a.type]||m.def)(a,f.nodes(a.source),f.nodes(a.target),this.contexts.edges,w)}if(x)for(m=sigma.canvas.nodes,e=this.nodesOnScreen,i=0,h=e.length;h>i;i++)e[i].hidden||(m[e[i].type]||m.def)(e[i],this.contexts.nodes,w);if(b)for(m=sigma.canvas.labels,e=this.nodesOnScreen,i=0,h=e.length;h>i;i++)e[i].hidden||(m[e[i].type]||m.def)(e[i],this.contexts.labels,w);return this.dispatchEvent("render"),this},sigma.renderers.canvas.prototype.initDOM=function(t,s){var e=document.createElement(t);e.style.position="absolute",e.setAttribute("class","sigma-"+s),this.domElements[s]=e,this.container.appendChild(e),"canvas"===t.toLowerCase()&&(this.contexts[s]=e.getContext("2d"))},sigma.renderers.canvas.prototype.resize=function(s,e){var i,n=this.width,h=this.height,a=1;if(s!==t&&e!==t?(this.width=s,this.height=e):(this.width=this.container.offsetWidth,this.height=this.container.offsetHeight,s=this.width,e=this.height),n!==this.width||h!==this.height)for(i in this.domElements)this.domElements[i].style.width=s+"px",this.domElements[i].style.height=e+"px","canvas"===this.domElements[i].tagName.toLowerCase()&&(this.domElements[i].setAttribute("width",s*a+"px"),this.domElements[i].setAttribute("height",e*a+"px"),1!==a&&this.contexts[i].scale(a,a));return this},sigma.renderers.canvas.prototype.clear=function(){var t;for(t in this.domElements)"CANVAS"===this.domElements[t].tagName&&(this.domElements[t].width=this.domElements[t].width);return this},sigma.utils.pkg("sigma.canvas.nodes"),sigma.utils.pkg("sigma.canvas.edges"),sigma.utils.pkg("sigma.canvas.labels")}).call(this);